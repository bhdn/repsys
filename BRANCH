The detached binaries repository
================================

A brief description:

All binaries from packages sources (ie. all the binary files inside
SOURCES/) will be placed in another subversion repository. This repository
is called "binaries repository" or "tarballs repository". It will contain
mostly the same directory structure of the main repository, but instead of
having SOURCES and SPECS, it will only have a SOURCES-bin directory. Every
copy/move operation should happen in both repositories.

Why a new repository without the tarballs
==========================================

- the current svn repository is too large, hard to manage
- there is no easy way to strip undesired tarballs without recreating the
  whole repository
- ...


Drawbacks of this layout
=========================

- (always) everything that changes the single-repository usage increases the chance
  of failure and make things more complicated.
- ...


Interesting use cases (first phase)
==================================

repsys co 2008.1/mutt
---------------------

- repsys checkouts
  http://svn.mandriva.com/svn/packages/updates/2008.1/mutt/current to the
  mutt directory

- repsys checkouts
  http://svn.mandriva.com/svn/binrepo/updates/2008.1/mutt/current/SOURCES-bin
  into mutt/SOURCES-bin

- creates symlinks for all files found in SOURCES-bin/ into ../SOURCES/

  (rpm doesn't handle symlinks, this allows us to have explicit links and
   proper src.rpm generates by rpmbuild)

In case the path doesn't exist in the binrepo it will not fail, as we may
have not imported all packages or the repository is not prepared to work on
this model, etc.

markrelease of a package
------------------------

   $ repsys markrelease 

- will copy current/ to releases/VERSION/RELEASE, as usual

- will copy current/ to releases/, on the binrepo 

- and will perform this copy on the binrepo too

Optionally, markrelease could create revprops indicating which is the
revision of current/ on the binrepo that represents the tarballs that are
being tagged.


Use cases to be implemented after the first phase
=================================================

upgrading to a newer version of the package
-------------------------------------------

  $ cd bla/SOURCES/
  $ wget http://prdownloads.sourceforge.net/bla/bla-1.6.tar.bz2
  $ repsys add bla-1.6.0.tar.bz2

- repsys notices this is a tarball (checking filename and/or file size)

- repsys will move the file to SOURCES-bin/, create the symlink, and svn-add
  it to the working copy

  $ # the user updates the spec

  $ repsys rm SOURCES/bla-1.5.1.tar.bz2

- it will remove the symlink and run svn rm on
  SOURCES-bin/bla-1.6.0.tar.bz2

  $ cd ../ # package top dir
  $ repsys ci

- repsys will commit the new tarball on SOURCES-bin/ and then on the rest
  of the working copy

repsys sync would perform these steps too.

importing a package
-------------------

  $ repsys putsrpm mypkg.src.rpm

- repsys will open the src.rpm

- will look for tarballs inside SOURCES/ and import them to
  http://svn.mandriva.com/svn/binrepo/cooker/mypkg/current/SOURCES/

- will move the tarballs out of SOURCES and import the remaining files to
  http://svn.mandriva.com/svn/packages/cooker/mypkg/current/

- will do whatever else putsrpm already does

Description
===========

Support separate repositories for tarballs.

TODO
=====

- Rename SOURCES/sources to SOURCES/binrepo.lst; less ambiguity when
  discussing about package structure. (DONE)

- Support no-tarballs-and-no-binrepo.lst repositories: (MUST)

  + Support checkout and getsrpm without binrepo.lst (DONE)

    * binrepo.enabled() returns true if binrepo is enabled in conf (DONE)

    * download from binrepo those files that are referred in the spec but
      are not found in the svn checkout/export (DONE)

    * adapt upload (MUST)

    * change "up" to look only for the missing files when binrepo.lst is
      not available (MUST)

    * adapt markrelease (MUST)
    
  + Enforce binrepo.lst on markrelease;

  + Enforce binrepo.lst on submit.

- Support updates/:

  + Merge the work from branch V1_6_X.feature.support-update-urls  (TODO)

